This logic is a simple state machine.